{% extends "base.html" %}

{% block title %}Customize layout{% endblock %}

{% block jsimports %}
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
{% endblock %}

{% block customCSS %}
    <style>
        body {
            
            background-image: url('/static/images/layout-setup-background.jpg');
            
        }

        /* Style for labels */
        label {
            font-family: 'Poppins', sans-serif;
            display: block;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            color: rgb(75, 75, 75);
        }

        /* Style for input fields */
        input {
            font-family: 'Poppins', sans-serif;
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Style for the button */
        button {
            font-family: 'Poppins', sans-serif;
            margin-top: 15px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            background: #396592;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }   

        [aria-hidden] {
            display: flex;
            gap: 0.02ch;
            align-items: center;
            color: white;
        }
    </style>
{% endblock %} 

{% block content %}
    <div class="container mt-5">
        <div class="d-flex justify-content-center">
            <h1 class="title-h1">
                <span style="font-size: 40;">Customize</span>
                <span class="sr-only" style="font-size: 50;">Your</span>
                <span aria-hidden="true">
                    <span>Y</span>
                    <span class="stretch-o"></span>
                    <span>ur</span>
                </span>
                <span style="font-size: 50;">Workspace Layout</span>
            </h1>
        </div>
        
        <div class="d-flex justify-content-center">
            <div class="setup-box">
                <label for="deskCount">Number of Desks:</label>
                <input type="number" id="deskCount" value="2" min="0" max="21">
    
                <label for="meetingCount">Number of Meeting Rooms:</label>
                <input type="number" id="meetingCount" value="1" min="0" max="10">
                <button class="mt-3" onclick="createItems()">Create Items</button>
            </div>
        </div>

        <div class="d-flex justify-content-center">
            <div id="layout" style="border-radius: 5%;"></div>
        </div>

        <div class="d-flex justify-content-center">
            <button  id="saveBtn">Save Button</button>
        </div>
        
    </div>   

    <script>
        // Function to create the draggable items
        function createItems() {
            const layout = document.getElementById("layout");
            layout.innerHTML = "";  // Clear any existing items

            const deskCount = parseInt(document.getElementById("deskCount").value, 10);
            const meetingCount = parseInt(document.getElementById("meetingCount").value, 10);

            // Calculate layout dimensions
            const layoutWidth = layout.offsetWidth;
            const layoutHeight = layout.offsetHeight;

            // Define item dimensions and spacing
            const deskWidth = 80;
            const deskHeight = 80;
            const padding = 20;
            const itemsPerRow = Math.floor((layoutWidth - padding * 2) / (deskWidth + padding));

            // Create desk items with grid-like positioning
            for (let i = 0; i < deskCount; i++) {
                const desk = document.createElement("img");
                desk.src = "/static/images/desk.png";
                desk.classList.add("draggable");
                desk.setAttribute("data-id", "desk-" + i);
                desk.style.width = deskWidth + "px";
                desk.style.height = deskHeight + "px";
                desk.style.position = "absolute";

                // Calculate grid position
                const row = Math.floor(i / itemsPerRow);
                const col = i % itemsPerRow;

                // Calculate x and y positions
                const x = padding + col * (deskWidth + padding);
                const y = padding + row * (deskHeight + padding);

                // Only place the desk if it fits within the layout
                if (y + deskHeight <= layoutHeight - padding) {
                    desk.style.left = x + "px";
                    desk.style.top = y + "px";
                    layout.appendChild(desk);
                }
            }

            // Similar approach for meeting rooms
            const meetingWidth = 120;
            const meetingHeight = 120;
            const meetingsPerRow = Math.floor((layoutWidth - padding * 2) / (meetingWidth + padding));

            for (let j = 0; j < meetingCount; j++) {
                const meeting = document.createElement("img");
                meeting.src = "/static/images/meeting-room.png";
                meeting.classList.add("draggable");
                meeting.setAttribute("data-id", "meeting-" + j);
                meeting.style.width = meetingWidth + "px";
                meeting.style.height = meetingHeight + "px";
                meeting.style.position = "absolute";

                // Calculate grid position for meeting rooms
                const row = Math.floor(j / meetingsPerRow);
                const col = j % meetingsPerRow;

                // Calculate x and y positions, starting from the bottom of the desks
                const x = padding + col * (meetingWidth + padding);
                const y = layoutHeight - (padding + meetingHeight) - (row * (meetingHeight + padding));

                // Only place the meeting room if it fits within the layout
                if (y >= padding) {
                    meeting.style.left = x + "px";
                    meeting.style.top = y + "px";
                    layout.appendChild(meeting);
                }
            }

            // Initialize drag functionality
            interact('.draggable').draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: 'parent',
                        endOnly: true
                    })
                ],
                autoScroll: true,
                listeners: {
                    move: dragMoveListener
                }
            });
        }

        // Listener to update the element's translation on drag
        function dragMoveListener(event) {
            const target = event.target;
            // Use custom attributes to keep track of the translation
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

            // Apply the translation via CSS transform
            target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';

            // Update the position attributes
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        // When the user clicks the "Save Layout" button,
        // collect the coordinates and send them to the Flask server.
        document.getElementById("saveBtn").addEventListener("click", function () {
            const items = document.querySelectorAll('.draggable');
            const layoutData = [];

            items.forEach(item => {
                const id = item.getAttribute("data-id");
                // Calculate final position: original offset plus translation
                const rect = item.getBoundingClientRect();
                const parentRect = document.getElementById("layout").getBoundingClientRect();
                const x = rect.left - parentRect.left;
                const y = rect.top - parentRect.top;

                layoutData.push({ id: id, coordX: Math.round(x), coordY: Math.round(y) });
            });

            // Send the data to the Flask endpoint via POST request
            fetch('/save_layout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(layoutData)
            })
                .then(response => response.json())
                .then(data => {
                    alert('Layout saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving layout:', error);
                });
        });
    </script>
{% endblock %}